<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>trollchipss.redaﾃｧao</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fontes Inter e Font Awesome para ﾃｭcones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
      <style>
        /* Variﾃ｡veis CSS combinadas - priorizando o conjunto mais abrangente do expansao.php */
        :root {
  /* --- Cores principais --- */
  --primary: #1e90ff; /* Azul principal */
  --primary-dark: #1c86ee; /* Azul mais escuro */
  --primary-light: #63b3ff; /* Azul claro */
  --primary-ultra-light: #cce4ff; /* Azul bem clarinho */

  /* --- Cores secundﾃ｡rias e fundo --- */
  --secondary: #0d0d0d; /* Mantﾃｩm contraste escuro para elementos secundﾃ｡rios */
  --secondary-light: #1a1a1a;
  --background: #001f3f; /* Fundo azul escuro */
  --background-light: #003366; /* Fundo azul um pouco mais claro */

  /* --- Cards e interaﾃｧﾃｵes --- */
  --card: #00264d; /* Azul escuro para cartﾃｵes */
  --card-hover: #003366; /* Hover azul */
  
  /* --- Textos --- */
  --text-primary: #f0f0f0; /* Branco para contraste */
  --text-secondary: #b0b0b0;
  --text-muted: #808080;

  /* --- Feedback --- */
  --success: #48bb78; /* Verde */
  --error: #f56565;   /* Vermelho */
  --warning: #ed8936; /* Laranja */

  /* --- Bordas e sombras --- */
  --border: #333333;
  --border-light: rgba(255, 255, 255, 0.1);
  --shadow: rgba(0, 0, 0, 0.5);
  --shadow-lg: rgba(0, 0, 0, 0.7);

  /* --- Efeitos de brilho --- */
  --glow: rgba(30, 144, 255, 0.5); /* Azul glow */
  --glow-intense: rgba(30, 144, 255, 1);
  --pulse-glow: rgba(30, 144, 255, 0.8);

  /* --- Efeito glassmorphism --- */
  --glass-bg: rgba(0, 38, 77, 0.05); /* Transparﾃｪncia azulada */
  --glass-border: rgba(255, 255, 255, 0.08);

  /* --- Discord-style (opcional) --- */
  --discord-gray: #2C2F33;
  --discord-dark-gray: #23272A;
        }
            /* Imagem de fundo personalizada do expansao.php */
            --custom-background-image: url('https://trollchipss.netlify.app/logo-trollchips.png');
            --custom-background-position: center;
            --custom-background-size: cover;
            --custom-background-repeat: no-repeat;
        }

        /* Estilos globais e de barra de rolagem do expansao.php */
        html {
            scroll-behavior: smooth;
            scrollbar-width: none;
            height: 100%;
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        ::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-image: var(--custom-background-image);
            background-position: var(--custom-background-position);
            background-size: var(--custom-background-size);
            background-repeat: var(--custom-background-repeat);
            background-attachment: fixed;
            background-color: transparent; /* Fundo transparente */
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 20px; /* MODIFICAﾃﾃグ: Ajuste no padding para o header */
            position: relative;
            font-weight: 400;
        }

        /* MODIFICAﾃﾃグ: Header Fixo */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: rgba(28, 28, 28, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            z-index: 1010;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Alterado de flex-end para flex-start */
        }

        .header-back-button {
            background-color: transparent;
            border: 1px solid var(--primary-light);
            color: var(--primary-light);
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .header-back-button:hover {
            background-color: var(--primary);
            color: white;
        }


        /* Preloader do expansao.php */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--custom-background-image);
            background-position: var(--custom-background-position);
            background-size: var(--custom-background-size);
            background-repeat: var(--custom-background-repeat);
            background-color: var(--background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease-out;
        }
        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-top: 3px solid var(--primary-light);
            border-right: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            filter: drop-shadow(0 0 20px var(--glow));
        }
        .loader::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 2px solid var(--primary-ultra-light);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }
        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Container de partﾃｭculas do expansao.php */
        #particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind content */
            pointer-events: none;
        }
        .particle {
            position: absolute;
            background-color: var(--primary-light);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 6px var(--primary-light), 0 0 12px var(--primary-light);
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.4; }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }

        /* Overlay de carregamento do tarefas.php (para carregamento dentro do aplicativo) */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        #loadingOverlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        #loadingOverlay img {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            border-radius: 50%;
        }
        #loadingOverlay .loading-title { /* NOVO: Tﾃｭtulo dinﾃ｢mico */
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }
        #loadingOverlay .loading-message { /* NOVO: Mensagem dinﾃ｢mica */
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .main-layout.blurred-content {
            filter: blur(5px);
            transition: filter 0.3s ease-in-out;
        }

        /* Layout principal do tarefas.php - Removido sidebar e header */
        .main-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh; /* Ajustado para min-height para permitir rolagem */
            background-color: transparent; /* Fundo transparente */
            animation: fadeIn 0.5s ease-out;
            position: relative;
            padding: 20px; /* Adicionado padding para o conteﾃｺdo principal */
            box-sizing: border-box;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

       
        
       
        /* Cartﾃ｣o de tarefa do tarefas.php */
        .task-card-container {
            position: relative;
            height: 180px;
            width: 100%;
        }
        .task-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            z-index: 1;
        }
        .task-card.expandido {
            height: auto;
            max-height: 400px;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .task-card-subject {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-light);
            text-transform: uppercase;
        }
        .task-card-status {
            background-color: rgba(138, 43, 226, 0.2); /* Ajustado rgba */
            border-radius: 0.5rem;
            padding: 0.1rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary-light);
            text-transform: uppercase;
        }
        .task-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .task-card.expandido .task-card-title {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        .task-card-details-on-hover {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-top 0.4s ease-out, padding-top 0.4s ease-out;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .task-card.expandido .task-card-details-on-hover {
            max-height: 250px;
            opacity: 1;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .task-proceed-button {
            width: 100%;
            text-align: center;
            background-color: transparent;
            border: 1px solid var(--primary-light);
            color: var(--primary-light);
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            max-height: 0;
            margin-top: 0;
            overflow: hidden;
            transition: background-color 0.2s ease, color 0.2s ease, opacity 0.3s ease-out, max-height 0.4s ease-out, margin-top 0.4s ease-out;
        }
        .task-card.expandido .task-proceed-button {
            opacity: 1;
            max-height: 100px;
            margin-top: 1rem;
        }
        .task-proceed-button:hover {
            background-color: var(--primary-dark);
            color: white;
        }
        .task-proceed-button:disabled {
            cursor: not-allowed;
            opacity: 0.5 !important;
            background-color: var(--card) !important;
            color: var(--text-muted) !important;
            border-color: var(--border) !important;
        }
        .task-card-dates {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .task-card-days-remaining {
            font-weight: 600;
        }
        .task-card-progress-bar-container {
            flex-grow: 1;
            margin: 0 0.5rem;
            min-width: 60px;
        }
        .task-card-progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .task-card-progress-bar-fill {
            background-color: var(--primary);
            border-radius: 3px;
            height: 100%;
        }
        
        /* MODIFICAﾃﾃグ: Ajuste no container de tarefas para alinhar com os filtros */
        #tasksContent {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            grid-auto-rows: min-content;
            align-items: start;
            position: relative;
            min-height: 500px;
            /* padding: 20px; */ /* Removido para alinhar com os filtros */
            /* Adicionado para criar um espaﾃｧo ﾃ direita, fazendo o container ocupar 80% da largura */
            width: 80%;
        }

      
       

        /* NOVO: Estilos para os badges de status no modal de lote */
        .batch-task-item .status-badge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .batch-task-item .status-badge.pending {
            background-color: rgba(138, 43, 226, 0.2); /* primary-light */
            color: var(--primary-light);
        }

        .batch-task-item .status-badge.expired {
            background-color: rgba(245, 101, 101, 0.2); /* error */
            color: var(--error);
        }

        .batch-task-item .status-badge.draft {
            background-color: rgba(237, 137, 54, 0.2); /* warning */
            color: var(--warning);
        }

        .batch-task-item .status-badge.processing {
            background-color: rgba(255, 255, 0, 0.2); /* Amarelo para processando */
            color: yellow;
        }

        
        /* Estilos para as estatﾃｭsticas do lote */
        .batch-stats {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .batch-stats strong {
            color: var(--text-primary);
        }


        .batch-processing-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }
        .batch-processing-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .batch-processing-modal-buttons .cancel-button {
            background-color: var(--card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .batch-processing-modal-buttons .cancel-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .batch-processing-modal-buttons .process-button {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: white;
        }
        .batch-processing-modal-buttons .process-button:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }


        /* Modal de Login do expansao.php (Estilos copiados para consistﾃｪncia) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.4s ease forwards;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--card);
            padding: 40px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border);
            box-shadow: 0 25px 70px rgba(138, 43, 226, 0.7);
            animation: scaleIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            display: flex;
            flex-direction: column;
            position: relative;
            isolation: isolate;
            box-sizing: border-box;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 24px;
            border: 2px solid transparent;
            background: linear-gradient(45deg, var(--primary-light), var(--primary)) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0.1;
        }
        .modal h2 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            background-image:
                linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.9) 50%, transparent 100%),
                linear-gradient(to right, var(--primary-dark) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 100%, 100% 100%;
            background-position: -200% 0, 0 0;
            animation: shimmer 2.5s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0, 0 0; }
            100% { background-position: 200% 0, 0 0; }
        }
        /* Especﾃｭfico do modal de login para corresponder ao expansao.php */
        #loginModal .modal-content {
            background: rgba(0, 0, 0, 0.75);
            border-radius: 24px !important;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            padding: 40px;
            backdrop-filter: blur(8px);
            animation: scaleIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        #loginModal .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        #loginModal .login-header h2 {
            font-size: 2.5rem;
            margin-top: 10px;
            margin-bottom: 10px;
            font-weight: 800;
            background-image:
                linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.9) 50%, transparent 100%),
                linear-gradient(to right, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 100%, 100% 100%;
            background-position: -200% 0, 0 0;
            animation: shimmer-login 4s linear infinite;
        }
        @keyframes shimmer-login {
            0% { background-position: -200% 0, 0 0; }
            100% { background-position: 200% 0, 0 0; }
        }
        #loginModal .login-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        #loginModal .input-group {
            margin-bottom: 25px;
            position: relative;
        }
        #loginModal .input-group input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: 0.3s;
        }
        #loginModal .input-group input[type="password"] {
             padding-right: 45px;
        }
        #loginModal .input-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px var(--glow);
            transform: none;
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            z-index: 10;
            font-size: 1.1rem;
        }
        .password-toggle:hover {
            color: var(--primary);
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 24px;
        }
        button {
            padding: 18px 26px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        /* MODIFICAﾃﾃグ: Estilos aprimorados para os botﾃｵes do modal de login */
        #loginModal .button-group button {
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 6px 25px var(--glow);
        }
        .btn-primary:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 35px var(--pulse-glow);
        }
        .btn-discord {
            background-color: var(--discord-gray);
            color: white;
            box-shadow: 0 6px 25px rgba(44, 47, 51, 0.5);
        }
        .btn-discord:hover {
            background-color: var(--discord-dark-gray);
            transform: translateY(-4px);
            box-shadow: 0 10px 35px rgba(35, 39, 42, 0.7);
        }
        
        /* Modal de Respostas */
        .answers-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            backdrop-filter: blur(8px); /* Aplicar blur ao fundo do modal */
        }
        .answers-modal.open {
            opacity: 1;
            visibility: visible;
        }
        .answers-modal-content {
            background-color: rgba(28, 28, 28, 0.9); /* Leve transparﾃｪncia */
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            margin-left: auto;
            margin-right: auto;
        }
        .answers-modal.open .answers-modal-content {
            transform: translateY(0);
        }
        .answers-modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 1.5rem;
        }
        .answers-modal-content .question-block {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .answers-modal-content .question-block h4 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .answers-modal-content .question-block p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        .answers-modal-content .question-block .correct-answer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-light);
            font-weight: 500;
            color: var(--success);
        }
        .answers-modal-content .question-block .correct-answer strong {
            color: var(--success);
        }
        .answers-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            flex-shrink: 0;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        .answers-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .answers-modal-buttons .close-modal-button {
            background-color: var(--card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .answers-modal-buttons .close-modal-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .answers-modal-scrollable-area {
            overflow-y: auto;
            flex-grow: 1;
            margin-bottom: 1.5rem;
            padding-right: 0.5rem;
        }


        /* NOVO: Estilos para as notificaﾃｧﾃｵes */
        .notification-container {
            position: fixed;
            top: 80px; /* Abaixo do header */
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none; /* Permite cliques atravﾃｩs do container */
        }

        .notification-item {
            background-color: var(--card);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 250px;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: all; /* Permite interaﾃｧﾃ｣o com a notificaﾃｧﾃ｣o */
        }

        .notification-item.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-item.hide {
            opacity: 0;
            transform: translateX(100%);
        }

        .notification-item.info {
            border-left: 5px solid var(--primary-light);
        }

        .notification-item.warning {
            border-left: 5px solid var(--warning);
        }

        .notification-item.success {
            border-left: 5px solid var(--success);
        }

        .notification-item.error {
            border-left: 5px solid var(--error);
        }

        .notification-item .icon {
            font-size: 1.2rem;
        }

        .notification-item .message {
            flex-grow: 1;
            font-size: 0.95rem;
        }

        /* Ajustes responsivos */
        @media (max-width: 1024px) { /* Em telas de tablet, mostrar 2 colunas */
            #tasksContent {
                grid-template-columns: repeat(2, 1fr);
                width: 100%; /* Ocupa a largura total em telas menores */
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 70px 10px 10px; /* Ajusta o padding do body para mobile */
            }
            .main-layout {
                padding: 10px; /* Ajusta o padding do main-layout para mobile */
            }
            .tarefasp-page-content {
                padding: 0;
                padding-bottom: 40vh;
            }
            .task-card {
                padding: 0.75rem;
                gap: 0.4rem;
            }
            .task-card-subject, .task-card-status, .task-card-dates {
                font-size: 0.7rem;
            }
            .task-card-title {
                font-size: 0.9rem;
            }
            .task-card.expandido {
                margin-top: 0;
            }
            .delivered-task-modal-content, .answers-modal-content, .task-processing-modal-content, .batch-processing-modal-content {
                width: 95%;
                max-width: none;
                padding: 1.5rem;
            }
            .tarefasp-filters {
                padding: 0;
            }
            #loginModal .modal-content {
                padding: 20px;
            }
            #loginModal .login-header h2 {
                font-size: 2rem;
            }
            #tasksContent {
                grid-template-columns: repeat(2, 1fr); /* 2 colunas em tablets */
            }
        }
        @media (max-width: 480px) {
            #tasksContent {
                grid-template-columns: 1fr; /* Coluna ﾃｺnica em telas muito pequenas */
                padding: 10px;
            }
            .tarefasp-filters {
                flex-direction: column; /* Empilha os filtros verticalmente */
                align-items: stretch;
            }
            .tarefasp-filters > div {
                width: 100%;
            }
            .tarefasp-filters button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
   
    <!-- Preloader do expansao.php -->
    <div id="preloader">
        <div class="loader"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <!-- Container de partﾃｭculas do expansao.php -->
    <div id="particle-container"></div>

   <!-- Overlay de carregamento do tarefas.php (para carregamento dentro do aplicativo) -->
 <!--   <div id="loadingOverlay" class="flex flex-col items-center justify-center">
        <img src="https://trollchipss.netlify.app/logo-trollchips.png" alt="Logo" class="mb-5 rounded-full">
        <p class="loading-title">Carregando...</p> <!-- Tﾃｭtulo dinﾃ｢mico -->
      <!--  <p class="loading-message">Sincronizando dados.</p> <!-- Mensagem dinﾃ｢mica --> 
   <!-- </div>

    <!-- Modal de Login Inicial (do expansao.php, ativo por padrﾃ｣o) -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <div class="login-header">
                <i class="fas fa-moon" style="font-size: 50px; margin-bottom: 15px; color: var(--primary-light);"></i>
                <h2>TROLLCHIPS 縲九 Redaﾃｧao</h2>
                <p>Log in with your credentials .</p>
            </div>

          </header>
    <main class="card">
      <div>
           <!-- Overlay de carregamento do tarefas.php (para carregamento dentro do aplicativo) -->
    <div id="loadingOverlay" class="flex flex-col items-center justify-center">
           <div class="image-container">
          <img src="https://trollchipss.netlify.app/logo-trollchips.png" alt="Logo" class="centered-image">
           <p class="loading-title">Carregando...</p> <!-- Tﾃｭtulo dinﾃ｢mico -->
        <p class="loading-message">Sincronizando dados.</p> <!-- Mensagem dinﾃ｢mica -->    
        </div>
        </div>
        <label for="ra">RA</label>
        <input class="field" id="ra" placeholder="RA + dﾃｭgito + sp | ex: 000000011xsp" autocomplete="username">
      </div>

      <div class="input-row">
        <label for="senha">Senha</label>
        <input class="field" id="senha" type="text" placeholder="Senha | ex: Aluno_2025" autocomplete="current-password">
        <button class="eye" type="button" id="toggleEye" style="top: 60.5px; transform: translateY(-50%);">白</button>
      </div>

      <div class="config-row">
        <div class="config-input">
          <label for="min-time">Tempo mﾃｭnimo (min)</label>
          <input type="number" id="min-time" value="5" min="1" max="60">
        </div>
        <div class="config-input">
          <label for="max-time">Tempo mﾃ｡ximo (min)</label>
          <input type="number" id="max-time" value="15" min="1" max="60">
        </div>
      </div>

      <div class="status">
        <button id="verifyBtn" aria-label="Verificar" style="width: 18px; height: 18px; border: 1px solid rgb(207, 215, 255); border-radius: 4px; background: transparent; cursor: pointer; display: none;"></button><button id="verifyBtn" aria-label="Verificar" style="width: 18px; height: 18px; border: 1px solid rgb(207, 215, 255); border-radius: 4px; background: transparent; cursor: pointer; display: none;"></button><button id="verifyBtn" aria-label="Verificar" style="width: 18px; height: 18px; border: 1px solid rgb(207, 215, 255); border-radius: 4px; background: transparent; cursor: pointer;"></button><span class="spinner" id="spinner" style="display: none;"></span> 
        <span id="statusText">Nﾃ｣o verificado</span>
        <button id="verifyBtn" aria-label="Verificar"></button>
      </div>

      <div class="stack">
        <button id="searchRedacaoBtn" class="btn primary" disabled="disabled"><i class="fas fa-search"></i> Redaﾃｧﾃ｣o Pendente</button>
        <button class="btn" disabled="disabled">Redaﾃｧﾃ｣o Expiradas</button>
      </div>
    <div id="msgArea" style="margin-top: 10px; color: rgb(162, 173, 207); font-size: 14px;"></div><div id="msgArea" style="margin-top: 0px; color: rgb(162, 173, 207); font-size: 14px;"></div><div id="msgArea" style="margin-top: 0px; color: rgb(162, 173, 207); font-size: 14px;"></div></main>

                </div>
            </form>
        </div>
    </div>

  

    <!-- NOVO: Modal de Processamento de Tarefa (Individual) -->
    <div id="taskProcessingModal" class="task-processing-modal">
        <div class="task-processing-modal-content">
            <h3 id="processingModalTitle" class="text-center">Processando Tarefa</h3>
            <div id="processingTaskDetails" class="mb-4 p-4 rounded-lg bg-gray-800 border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <p id="modalProcessingSubject" class="task-card-subject"></p>
                    <span id="modalProcessingStatus" class="task-card-status"></span>
                </div>
                <p id="modalProcessingTitle" class="task-card-title text-lg mb-2"></p>
                <div class="text-xs space-y-1">
                    <p id="modalProcessingDescription" class="mb-2 text-gray-400"></p>
                    <hr class="border-gray-700 my-2">
                    <p><b>ID da tarefa:</b> <span id="modalProcessingTaskId"></span></p>
                    <p><b>Primeiro Acesso:</b> <span id="modalProcessingFirstAccess"></span></p>
                </div>
            </div>

            <div class="input-group">
                <label for="minTime">Tempo mﾃｭn. (minutos):</label>
                <input type="number" id="minTime" placeholder="Ex: 30" min="0">
            </div>
            <div class="input-group">
                <label for="maxTime">Tempo mﾃ｡x. (minutos):</label>
                <input type="number" id="maxTime" placeholder="Ex: 60" min="0">
            </div>
            <div class="task-processing-modal-buttons">
                <button id="saveDraftButton" class="save-draft-button">Salvar como rascunho</button>
                <button id="doTaskButton" class="do-task-button">Fazer tarefa</button>
            </div>
        </div>
    </div>

    <!-- MODIFICAﾃﾃグ: Modal de Processamento em Lote com novos botﾃｵes -->
    <div id="batchProcessingModal" class="batch-processing-modal">
        <div class="batch-processing-modal-content">
            <h3 class="text-center">Processar Tarefas em Lote</h3>
            <div class="input-group">
                <label for="batchMinTime">Tempo mﾃｭn. (minutos):</label>
                <input type="number" id="batchMinTime" placeholder="Ex: 30" min="0">
            </div>
            <div class="input-group">
                <label for="batchMaxTime">Tempo mﾃ｡x. (minutos):</label>
                <input type="number" id="batchMaxTime" placeholder="Ex: 60" min="0">
            </div>
            
            <!-- Controles de seleﾃｧﾃ｣o em lote -->
            <div class="flex items-center justify-start gap-2 mb-2">
                <button id="batchSelectAll" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Selecionar Todas</button>
                <button id="batchSelectAllDraft" class="text-xs bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Todas como Rascunho</button>
                <button id="batchDeselectAll" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Limpar Seleﾃｧﾃ｣o</button>
            </div>

            <div class="batch-tasks-list" id="batchTasksList">
                <!-- As tarefas serﾃ｣o carregadas aqui -->
                <p class="text-gray-500 text-center">Nenhuma tarefa pendente encontrada.</p>
            </div>

            <div class="batch-processing-modal-buttons">
                <button id="closeBatchProcessingModal" class="cancel-button">Cancelar</button>
                <button id="processSelectedTasksButton" class="process-button">Processar Tarefas Selecionadas</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal para exibir respostas das tarefas -->
    <div id="answersModal" class="answers-modal">
        <div class="answers-modal-content">
            <h3>Respostas da Tarefa</h3>
            <div id="answersContent" class="answers-modal-scrollable-area">
                <!-- As respostas serﾃ｣o carregadas aqui -->
            </div>
            <div class="answers-modal-buttons">
                <button id="closeAnswersModal" class="close-modal-button">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Container para notificaﾃｧﾃｵes -->
    <div id="notificationContainer" class="notification-container"></div>


    <!-- Layout Principal do Dashboard (do tarefas.php, oculto inicialmente) -->
    <div class="main-layout hidden" id="mainSection">
        <!-- Removida a sidebar e o header completamente -->
        <main class="tarefasp-page-content">
            <!-- ﾃ皇one e Tﾃｭtulo Tarefa SP -->
            <div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-12 css-hpjul1 flex items-center gap-4 mb-6">
                <svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-13mjey1" focusable="false" aria-hidden="true" viewBox="0 0 57 64" data-testid="TarefaSPIcon" width="57" height="64" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-14 h-16">
                    <title>Tarefa SP</title>
                    <mask id="path-1-inside-1_14741_59229" fill="white">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.0922 0.702148C6.32782 0.702148 0.844238 6.18573 0.844238 12.9501V44.5156C0.844238 51.28 6.32782 56.7636 13.0922 56.7636H23.1812C23.228 56.8653 23.2801 56.9663 23.3378 57.0662L25.8444 61.4078C27.1913 63.7407 30.5586 63.7407 31.9055 61.4078L34.4121 57.0662C34.4698 56.9663 34.5219 56.8653 34.5687 56.7636H44.6577C51.4221 56.7636 56.9056 51.28 56.9056 44.5156V12.9501C56.9056 6.18573 51.4221 0.702148 44.6577 0.702148H13.0922Z"></path>
                    </mask>
                    <path d="M23.1812 56.7636L26.269 55.3459L25.36 53.3659H23.1812V56.7636ZM23.3378 57.0662L26.2802 55.3674L26.2802 55.3674L23.3378 57.0662ZM25.8444 61.4078L28.7868 59.709L25.8444 61.4078ZM31.9055 61.4078L34.848 63.1066L31.9055 61.4078ZM34.4121 57.0662L31.4697 55.3674L31.4697 55.3674L34.4121 56.7636ZM34.5687 56.7636V53.3659H32.39L31.4809 55.3459L34.5687 56.7636ZM4.2419 12.9501C4.2419 8.0622 8.20429 4.09981 13.0922 4.09981V-2.69551C4.45134 -2.69551 -2.55342 4.30925 -2.55342 12.9501H4.2419ZM4.2419 44.5156V12.9501H-2.55342V44.5156H4.2419ZM13.0922 53.3659C8.20429 53.3659 4.2419 49.4035 4.2419 44.5156H-2.55342C-2.55342 53.1565 4.45134 60.1612 13.0922 60.1612V53.3659ZM23.1812 53.3659H13.0922V60.1612H23.1812V53.3659ZM26.2802 55.3674C26.2751 55.3585 26.2715 55.3513 26.269 55.3459L20.0935 58.1812C20.1844 58.3793 20.2851 58.5741 20.3953 58.7651L26.2802 55.3674ZM28.7868 59.709L26.2802 55.3674L20.3953 58.765L22.9019 63.1066L28.7868 59.709ZM28.9631 59.709C28.949 59.7334 28.9395 59.7427 28.9379 59.7443C28.9357 59.7464 28.9345 59.7473 28.9326 59.7483C28.927 59.7514 28.9072 59.7598 28.875 59.7598C28.8427 59.7598 28.8229 59.7514 28.8174 59.7483C28.8154 59.7473 28.8142 59.7464 28.8121 59.7443C28.8104 59.7427 28.8009 59.7334 28.7868 59.709L22.9019 63.1066C25.5566 67.7047 32.1933 67.7047 34.848 63.1066L28.9631 59.709ZM31.4697 55.3674L28.9631 59.709L34.848 63.1066L37.3546 58.765L31.4697 55.3674ZM31.4809 55.3459C31.4784 55.3513 31.4748 55.3585 31.4697 55.3674L37.3546 58.7651C37.4648 58.5741 37.5655 58.3793 37.6564 58.1812L31.4809 55.3459ZM44.6577 53.3659H34.5687V60.1612H44.6577V53.3659ZM53.508 44.5156C53.508 49.4035 49.5456 53.3659 53.508 44.5156H60.3033C60.3033 53.1565 53.2985 60.1612 44.6577 60.1612V53.3659ZM53.508 12.9501V44.5156H60.3033V12.9501H53.508ZM44.6577 4.09981C49.5456 4.09981 53.508 8.0622 53.508 12.9501H60.3033C60.3033 4.30925 53.2985 -2.69551 44.6577 -2.69551V4.09981Z" fill="#162F67" mask="url(#path-1-inside-1_14741_59229)"></path>
                    <rect x="11.8868" y="11.7442" width="34.2108" height="34.2108" rx="5.49962" stroke="#162F67" stroke-width="3.39766"></rect>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M40.5156 21.0031C40.847 21.3346 41.0332 21.7842 41.0332 22.2529C41.0332 22.7217 40.847 23.1713 40.5156 23.5028L27.2649 36.7535C27.0898 36.9286 26.8819 37.0676 26.6531 37.1624C26.4243 37.2571 26.179 37.3059 25.9314 37.3059C25.6837 37.3059 25.4384 37.2571 25.2096 37.1624C24.9808 37.0676 24.7729 36.9286 24.5978 36.7535L18.0143 30.1712C17.8455 30.0081 17.7108 29.813 17.6181 29.5973C17.5255 29.3816 17.4767 29.1497 17.4747 28.9149C17.4726 28.6802 17.5174 28.4474 17.6063 28.2301C17.6951 28.0129 17.8264 27.8155 17.9924 27.6495C18.1584 27.4835 18.3558 27.3522 18.573 27.2633C18.7903 27.1745 19.0231 27.1297 19.2578 27.1318C19.4926 27.1338 19.7245 27.1826 19.9402 27.2752C20.1559 27.3679 20.351 27.5026 20.5141 27.6714L25.9308 33.0881L38.0147 21.0031C38.1788 20.8388 38.3738 20.7085 38.5883 20.6195C38.8029 20.5306 39.0329 20.4849 39.2651 20.4849C39.4974 20.4849 39.7274 20.5306 39.9419 20.6195C40.1565 20.7085 40.3514 20.8388 40.5156 21.0031Z" fill="#26A95E"></path>
                </svg>
                <h5 class="MuiTypography-root MuiTypography-h5 text-xl font-semibold text-white" data-testid="tarefa-sp">Tarefa SP</h5>
            </div>

            <!-- Conteﾃｺdo da Pﾃ｡gina de Tarefa SP -->
            <div class="tarefasp-header">
                <h2>Tarefa SP</h2>
                <p class="text-sm text-gray-400 mt-1">
                    <a href="dashboard" class="hover:underline">Home</a> / Tarefa SP
                </p>
            </div>

            <!-- Filtros -->
            <div class="tarefasp-filters">
                <div class="relative">
                    <label>Turmas:</label>
                    <button id="allClassesButton" class="rounded-xl">Todas as turmas</button>
                </div>
                <div class="relative">
                    <label>Status:</label>
                    <button id="toDoButton" class="rounded-xl">A fazer</button>
                    <div id="statusFilterDropdown" class="status-filter-dropdown">
                        <button id="filterToDo" class="selected">A fazer</button>
                        <button id="filterDelivered">Entregues</button>
                        <button id="filterExpired">Expiradas</button>
                    </div>
                </div>
                <!-- Removido o botﾃ｣o "Componentes" e "Todos os Componentes" -->
                <div class="relative">
                    <label>&nbsp;</label> <!-- Espaﾃｧo para alinhar com os outros labels -->
                    <button id="processAllTasksButton" class="rounded-xl">Processar todas as tarefas</button>
                </div>
            </div>

            <div id="tasksContent">
                <!-- As tarefas serﾃ｣o carregadas aqui pelo JavaScript -->
                <p id="noTasks" class="text-gray-400 text-center col-span-full">Nenhuma tarefa encontrada.</p>
            </div>
        </main>
    </div>
 
    
    <div class="overlay" id="sidebarOverlay"></div>

    <script>
       // Configuraﾃｧﾃ｣o e inicializaﾃｧﾃ｣o das partﾃｭculas
    document.addEventListener('DOMContentLoaded', function() {
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#ffffff" },
                shape: {
                    type: "circle",
                    stroke: { width: 0, color: "#000000" },
                    polygon: { nb_sides: 5 }
                },
                opacity: {
                    value: 0.5,
                    random: true,
                    anim: { enable: true, speed: 1, opacity_min: 0.1, sync: false }
                },
                size: {
                    value: 3,
                    random: true,
                    anim: { enable: true, speed: 2, size_min: 0.1, sync: false }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#ffffff",
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: "none",
                    random: true,
                    straight: false,
                    out_mode: "out",
                    bounce: false,
                    attract: { enable: false, rotateX: 600, rotateY: 1200 }
                }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "grab" },
                    onclick: { enable: true, mode: "push" },
                    resize: true
                },
                modes: {
                    grab: { distance: 140, line_linked: { opacity: 1 } },
                    push: { particles_nb: 4 }
                }
            },
            retina_detect: true
        });
    });

    // 1) Neutralizar a auto-verificaﾃｧﾃ｣o (sem apagar nada):
    const statusEl = document.querySelector('.status');
    const oldSpinner = document.getElementById('spinner');
    const oldText = document.getElementById('statusText');

    // Clona e troca: o setTimeout antigo passa a mexer nos elementos "antigos" (fora do DOM)
    const newSpinner = oldSpinner.cloneNode(true);
    newSpinner.style.display = 'none';
    statusEl.replaceChild(newSpinner, oldSpinner);

    const newText = oldText.cloneNode(true);
    newText.textContent = 'Nﾃ｣o verificado';
    statusEl.replaceChild(newText, oldText);

    // 2) Inserir o quadradinho de verificaﾃｧﾃ｣o ao lado do status
    const verifyBtn = document.createElement('button');
    verifyBtn.setAttribute('id','verifyBtn');
    verifyBtn.setAttribute('aria-label','Verificar');
    Object.assign(verifyBtn.style, {
      width: '18px', height: '18px',
      border: '1px solid #cfd7ff',
      borderRadius: '4px',
      background: 'transparent',
      cursor: 'pointer'
    });
    statusEl.insertBefore(verifyBtn, newSpinner);

    // 3) Desativar aﾃｧﾃｵes atﾃｩ verificar e criar mensagens
    const [btnPendentes, btnExpiradas] = document.querySelectorAll('.stack .btn');
    btnPendentes.disabled = true;
    btnExpiradas.disabled = true;

    const msg = document.createElement('div');
    msg.id = 'msgArea';
    Object.assign(msg.style, { marginTop: '0px', color: '#A2ADCF', fontSize: '14px' });
    document.querySelector('.card').appendChild(msg);

    function handleAction(tipo) {
      const verified = newText.textContent.trim().startsWith('笨');
      if (!verified) {
        msg.textContent = 'Clique no quadradinho para verificar antes de continuar.';
        return;
      }
      if (tipo === 'pendentes') {
        msg.textContent = '';
        setTimeout(() => { msg.textContent = ''; }, 1200);
      } else {
        msg.textContent = '';
        setTimeout(() => { msg.textContent = 'Esse Script So Faz Redaﾃｧﾃ｣o Pendentes'; }, 1200);
      }
    }

    btnPendentes.addEventListener('click', () => handleAction('pendentes'));
    btnExpiradas.addEventListener('click', () => handleAction('expiradas'));

    // 4) Fluxo do quadradinho: clicar -> some, mostra verificando -> 笨 Verificado
    verifyBtn.addEventListener('click', () => {
      verifyBtn.style.display = 'none';           // quadradinho some apﾃｳs o clique
      newSpinner.style.display = 'inline-block';  // mostra spinner
      newText.textContent = 'Verificando窶ｦ';
      setTimeout(() => {
        newSpinner.style.display = 'none';
        newText.textContent = '笨 Verificado';
        btnPendentes.disabled = false;
        btnExpiradas.disabled = false;
      }, 2000);
    });

    // 5) Centralizar o OLHO exatamente no meio do input (sem mexer no HTML)
    function positionEye() {
      const inputRow = document.querySelector('.input-row');
      const input = document.getElementById('senha');
      const eyeBtn = document.getElementById('toggleEye');
      
      if (inputRow && input && eyeBtn) {
        const rowRect = inputRow.getBoundingClientRect();
        const inputRect = input.getBoundingClientRect();
        const topInRow = (inputRect.top - rowRect.top) + (inputRect.height / 2);
        eyeBtn.style.top = topInRow + 'px';
        eyeBtn.style.transform = 'translateY(-50%)';
        // REMOVI a linha que mudava a cor para nﾃ｣o interferir
      }
    }

    // Agendar o posicionamento para nﾃ｣o conflitar com outros scripts
    window.addEventListener('load', function() {
      setTimeout(positionEye, 100);
    });

    window.addEventListener('resize', function() {
      setTimeout(positionEye, 100);
    });

    // Foco no primeiro campo
    window.addEventListener('load', () => document.getElementById('ra').focus());
  </script>

  <!-- Cﾃｳdigo JavaScript para funcionalidades de redaﾃｧﾃ｣o -->
  <script>
    (function () {

      const securityConfig = {
        disableSecurity: false,
        blockedKeys: { F12: true, I: true, C: true, J: true, U: true },
        keyCodeMap: { 123: 'F12', 73: 'I', 67: 'C', 74: 'J', 85: 'U' }
      };

      document.addEventListener('contextmenu', (e) => {
        if (!securityConfig.disableSecurity) e.preventDefault();
      });

      document.addEventListener('keydown', (e) => {
        if (securityConfig.disableSecurity) return;
        const key = securityConfig.keyCodeMap[e.keyCode] || e.key;
        if (key === 'F12' || (e.ctrlKey && e.shiftKey && securityConfig.blockedKeys[key])) e.preventDefault();
        if (e.ctrlKey && key === 'U') e.preventDefault();
      });

      const consoleProtection = new Error();
      Object.defineProperties(consoleProtection, {
        toString: {
          value() {
            if ((new Error()).stack.includes('toString@')) location.reload();
          }
        },
        message: {
          get() { location.reload(); }
        }
      });
      console.log(consoleProtection);

      function showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notificationsContainer');
        const notification = document.createElement('div');
        notification.className = `Notificacao ${type}`;
        
        notification.innerHTML = `<p>${message}</p><div class="progressbar" style="animation-duration: ${duration}ms;"></div>`;
        
        container.prepend(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 10);

        const removeNotification = (notif) => {
          if (notif && notif.parentNode) {
            notif.classList.remove('show');
            notif.classList.add('fadeOut');
            setTimeout(() => {
              if (notif.parentNode) {
                notif.remove();
              }
            }, 400);
          }
        };
        
        notification.addEventListener('click', () => removeNotification(notification));
        
        setTimeout(() => {
          removeNotification(notification);
        }, duration);
      }

      const togglePassword = document.getElementById('toggleEye');
      const passwordInput = document.getElementById('senha');
      if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', function() {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          // Alterar o ﾃｭcone do olho
          togglePassword.textContent = type === 'password' ? '早ｸ' : '白';
        });
      }
      
      const senhaInput = document.getElementById("senha");
      const raInput = document.getElementById("ra");
      const searchRedacaoBtn = document.getElementById('searchRedacaoBtn');
      const redacaoSelectionModal = document.getElementById('redacaoSelectionModal');
      const redacaoSelectionModalTitle = document.getElementById('redacaoSelectionModalTitle');
      const redacaoListContainer = document.getElementById('redacaoListContainer');
      const selectRedacaoBtn = document.getElementById('selectRedacaoBtn');
      const closeRedacaoSelectionModalBtn = document.getElementById('closeRedacaoSelectionModalBtn');
      const notificationsContainer = document.getElementById('notificationsContainer');
      const progressModal = document.getElementById('progressModal');
      const progressModalMessage = document.getElementById('progressModalMessage');
      const minTimeInput = document.getElementById('min-time');
      const maxTimeInput = document.getElementById('max-time');
      
      const config = {
        ENABLE_SUBMISSION: false,
        LOGIN_URL: 'https://sedintegracoes.educacao.sp.gov.br/credenciais/api/LoginCompletoToken',
        API_BASE_URL: 'https://edusp-api.ip.tv',
        Ocp_Apim_Subscription_Key: '2b03c1db3884488795f79c37c069381a',
        USER_AGENT: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
        GEMINI_API_KEYS: [
          'AIzaSyBm19Mf_N3Zb-uZOYF3UDvsnrtGVUjaUBk',
          'AIzaSyBPD0aDJArOiG1-qNmM1BUkNIDyqxIb-fw',
          'AIzaSyCiI2FUcOz_055I2ZrQ05IuIoqNmiZGV2Y',
          'AIzaSyBI0tP3ZG_ax2wW1Ivw8zbLWmMzMEDYjJM',
          'AIzaSyD6uxZZbrXSHhrm3Ysg_WvNWMtLGIGfndE',
          'AIzaSyAxSURXv2pKciZSFjxbNrvdYDx1Y6US1CU',
          'AIzaSyD9EoMlVzBY_Y1efyVKyL90QlySshnrnZI'
        ]
      };
      
      let trava = false;
      let currentFetchedRedacoes = [];
      let selectedRedacaoId = null;
      let currentAuthToken = null;
      let userNick = null;
      let currentTaskId = null;
      let currentRoomName = null;
      let currentQuestionId = null;
      let currentQuestionType = null;
      let currentRedacaoContent = null;
      
      const promptsGeracao = [
        `Crie uma redaﾃｧﾃ｣o escolar completa a partir das informaﾃｧﾃｵes abaixo. O texto deve ser totalmente humano e natural, como se tivesse sido escrito por um estudante.

Siga estas regras de forma obrigatﾃｳria:

1.A redaﾃｧﾃ｣o deve ter um tﾃｭtulo criativo.

2.Escreva o texto completo da redaﾃｧﾃ｣o, em parﾃ｡grafos corridos.

3.Nﾃ｣o use ** ou * em nenhum lugar do tﾃｭtulo ou do texto.

4.Nﾃ｣o adicione emojis, sﾃｭmbolos ou caracteres especiais em nenhuma parte da resposta.

5.Nﾃ｣o use sﾃｭmbolos como traﾃｧos longos ou reticﾃｪncias. Apenas utilize pontuaﾃｧﾃ｣o simples, como ponto final, vﾃｭrgula, ponto de interrogaﾃｧﾃ｣o ou exclamaﾃｧﾃ｣o.

6.O texto deve ser claro, acessﾃｭvel e coerente, mantendo um tom escolar.

7.A redaﾃｧﾃ｣o deve ter desenvolvimento suficiente, com introduﾃｧﾃ｣o, desenvolvimento e conclusﾃ｣o bem estruturados.

8.Nﾃ｣o escreva listas no texto final, apenas parﾃ｡grafos narrativos.

9.O resultado deve ser convincente como uma redaﾃｧﾃ｣o escolar real, com frases variadas e um fluxo natural.

10.Respeite rigorosamente a formataﾃｧﾃ｣o a seguir:

TITULO: [Tﾃｭtulo da redaﾃｧﾃ｣o]
TEXTO: [Texto da redaﾃｧﾃ｣o]

Aqui estﾃ｣o as informaﾃｧﾃｵes para a redaﾃｧﾃ｣o:
{dadosRedacao}

Lembre-se: devolva APENAS a redaﾃｧﾃ｣o pronta, sem comentﾃ｡rios, explicaﾃｧﾃｵes ou qualquer informaﾃｧﾃ｣o adicional.`,
      ];
      
      const promptsHumanizacao = [
       `Reescreva o seguinte texto acadﾃｪmico de forma mais natural, como se tivesse sido escrito por uma pessoa de verdade. O resultado deve parecer uma redaﾃｧﾃ｣o fluida, espontﾃ｢nea e completa, nﾃ｣o um texto feito por IA.
1.Aqui estﾃ｣o as instruﾃｧﾃｵes obrigatﾃｳrias que vocﾃｪ deve seguir:

2.Preserve todo o conteﾃｺdo, ideias e argumentos principais do texto original.

3.Expanda o texto, adicionando mais detalhes, explicaﾃｧﾃｵes e exemplos para que ele fique maior e mais completo, com mais linhas.

4.Use uma linguagem simples, clara e acessﾃｭvel, como se fosse um estudante escrevendo.

5.Varie o ritmo e o tamanho das frases para que o texto soe mais humano, evitando estruturas previsﾃｭveis e mecﾃ｢nicas.

6.Inclua pequenas imperfeiﾃｧﾃｵes e falhas naturais de escrita, como repetiﾃｧﾃｵes leves, pausas ou desvios sutis de gramﾃ｡tica e pontuaﾃｧﾃ｣o.

7.Utilize conectivos e expressﾃｵes comuns da fala e da escrita cotidiana, como "por outro lado", "no entanto", "alﾃｩm disso" e "de certa forma".

8.Reescreva exemplos e referﾃｪncias de modo mais simples e natural, sem soar tﾃｩcnico ou excessivamente formal.

9.Evite jargﾃｵes difﾃｭceis e termos muito acadﾃｪmicos. Prefira explicaﾃｧﾃｵes fﾃ｡ceis de compreender.

10.O tom deve ser consistente, com certa emoﾃｧﾃ｣o e personalidade, sem parecer artificial ou impessoal.

11.Nﾃ｣o use listas no texto final, nem sﾃｭmbolos especiais como traﾃｧos longos ou reticﾃｪncias. Escreva em parﾃ｡grafos corridos e narrativos.

12.O resultado deve ser um texto corrido, humano e convincente, pronto para ser lido como uma redaﾃｧﾃ｣o real.

Texto para reescrever:
{textoRedacao}

Devolva APENAS o texto reescrito, sem comentﾃ｡rios, explicaﾃｧﾃｵes ou marcaﾃｧﾃｵes adicionais.`,
      ];
      
      function getDefaultHeaders(authToken = null) {
        const headers = {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'x-api-realm': 'edusp',
          'x-api-platform': 'webclient',
          'User-Agent': config.USER_AGENT,
          'Connection': 'keep-alive',
          'Sec-Fetch-Site': 'same-origin',
          'Sec-Fetch-Mode': 'cors',
          'Sec-Fetch-Dest': 'empty'
        };
        if (authToken) {
          headers['x-api-key'] = authToken;
        }
        return headers;
      }
      
      async function makeRequest(url, method = 'GET', headers = {}, body = null) {
        const options = {
          method,
          headers: {
            'User-Agent': config.USER_AGENT,
            'Content-Type': 'application/json',
            ...headers
          }
        };
        if (body) {
          options.body = JSON.stringify(body);
        }
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`笶 HTTP ${method} ${url} => ${response.status}`);
        }
        return response.json();
      }
      
      function isRedacao(task) {
        return task.tags.some(t => t.toLowerCase().includes('redacao')) ||
          task.title.toLowerCase().includes('redaﾃｧﾃ｣o');
      }
      
      async function fetchRedacaoContent(taskId, token, roomName) {
        const url = `${config.API_BASE_URL}/tms/task/${taskId}/apply?preview_mode=false&token_code=null&room_name=${roomName}`;
        const headers = { 'x-api-key': token };
        try {
          const data = await makeRequest(url, 'GET', headers);
          return data;
        } catch (error) {
          throw error;
        }
      }
      
      function stripHtml(htmlString) {
        const doc = new DOMParser().parseFromString(htmlString, 'text/html');
        return doc.body.textContent || "";
      }
      
      function removeUrls(text) {
        const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+\/[^\s]*)/g;
        return text.replace(urlRegex, '').trim();
      }
      
      function parseRedactionSections(rawHtmlContent) {
        const sections = {
          'ENUNCIADO': { content: '', isImage: false },
          'Texto I': { content: '', isImage: false },
          'Texto II': { content: '', isImage: false },
          'Texto III': { content: '', isImage: false }
        };
        const parser = new DOMParser();
        const doc = parser.parseFromString(rawHtmlContent, 'text/html');
        const body = doc.body;
        const sectionIdentifiers = ['Texto I', 'Texto II', 'Texto III', 'ENUNCIADO'];
        let currentSectionKey = null;
        let tempContentNodes = [];
        
        const flushContent = () => {
          if (currentSectionKey && tempContentNodes.length > 0) {
            const sectionHtml = tempContentNodes.map(node => node.outerHTML || node.textContent).join('');
            const isImageSection = sectionHtml.includes('<img');
            sections[currentSectionKey].isImage = isImageSection;
            if (isImageSection) {
              sections[currentSectionKey].content = '[IMAGEM]';
            } else {
              sections[currentSectionKey].content = removeUrls(stripHtml(sectionHtml)).trim();
            }
          }
          tempContentNodes = [];
        };
        
        for (let i = 0; i < body.childNodes.length; i++) {
          const node = body.childNodes[i];
          if (node.nodeType === Node.ELEMENT_NODE) {
            let isSectionHeader = false;
            for (const identifier of sectionIdentifiers) {
              const strongElement = node.tagName === 'STRONG' ? node : node.querySelector('strong');
              if (strongElement && strongElement.textContent.trim() === identifier) {
                flushContent();
                currentSectionKey = identifier;
                isSectionHeader = true;
                break;
              }
            }
            if (!isSectionHeader) {
              if (currentSectionKey) {
                tempContentNodes.push(node);
              }
            }
          } else if (node.nodeType === Node.TEXT_NODE) {
            if (currentSectionKey) {
              tempContentNodes.push(node);
            }
          }
        }
        flushContent();
        return sections;
      }
      
      async function fetchGeminiContent(prompt) {
        const chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const randomKeyIndex = Math.floor(Math.random() * config.GEMINI_API_KEYS.length);
        const apiKey = config.GEMINI_API_KEYS[randomKeyIndex];
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erro da API Gemini: ${response.status} - ${JSON.stringify(errorData)}`);
          }
          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
          } else {
            return '';
          }
        } catch (error) {
          console.error('Erro ao chamar a API Gemini:', error);
          throw error;
        }
      }
      
      async function callGeminiAPI(redactionContent) {
        showNotification('Gerando redaﾃｧﾃ｣o...');
        try {
          const promptGeracaoAleatorio = promptsGeracao[Math.floor(Math.random() * promptsGeracao.length)]
            .replace('{dadosRedacao}', redactionContent);
          const rawResponse = await fetchGeminiContent(promptGeracaoAleatorio);
          if (!rawResponse.includes("TITULO:") || !rawResponse.includes("TEXTO:")) {
            throw new Error('Resposta da API Gemini nﾃ｣o contﾃｩm TITULO: ou TEXTO: esperados na geraﾃｧﾃ｣o inicial.');
          }
          const generatedTitle = rawResponse.split("TITULO:")[1].split("TEXTO:")[0].replace(/^Tﾃｭtulo:\s*/i, '').replace(/#/g, '').trim();
          const generatedText = rawResponse.split("TEXTO:")[1].trim();
          showNotification('Humanizando texto...');
          const promptHumanizacaoAleatorio = promptsHumanizacao[Math.floor(Math.random() * promptsHumanizacao.length)]
            .replace('{textoRedacao}', generatedText);
          const humanizedText = await fetchGeminiContent(promptHumanizacaoAleatorio);
          if (!humanizedText) {
            throw new Error('A humanizaﾃｧﾃ｣o retornou um texto vazio.');
          }
          return { title: generatedTitle, text: humanizedText };
        } catch (error) {
          console.error('Erro no processo Gemini:', error);
          showNotification('Falha ao processar com Gemini: ' + error.message, 'error');
          throw error;
        }
      }
      
      async function submitRedactionDraft(taskId, questionId, questionType, title, body, authToken, roomName, status, answerId = null) {
        showNotification('Enviando redaﾃｧﾃ｣o...');
        let url;
        let method;
        if (status === "draft" && answerId) {
          url = `${config.API_BASE_URL}/tms/task/${taskId}/answer/${answerId}`;
          method = "PUT";
        } else {
          url = `${config.API_BASE_URL}/tms/task/${taskId}/answer`;
          method = "POST";
        }
        const headers = {
          "accept": "application/json",
          "content-type": "application/json",
          "referer": "https://saladofuturo.educacao.sp.gov.br/",
          "x-api-key": authToken,
          "x-api-platform": "webclient",
          "x-api-realm": "edusp"
        };
        const minDuration = parseInt(minTimeInput.value) * 60 * 1000;
        const maxDuration = parseInt(maxTimeInput.value) * 60 * 1000;
        const duration = Math.floor(Math.random() * (maxDuration - minDuration + 1)) + minDuration;

        let requestBody;
        if (status === "draft") {
          requestBody = {
            status: "draft",
            accessed_on: "room",
            executed_on: "",
            duration: duration,
            answers: {
              [questionId]: {
                question_id: questionId,
                question_type: questionType,
                answer: {
                  title: title,
                  body: body
                }
              }
            }
          };
        } else {
          requestBody = {
            status: "draft",
            accessed_on: "room",
            executed_on: `${roomName}`,
            duration: duration,
            answers: {
              [questionId]: {
                question_id: questionId,
                question_type: questionType,
                answer: {
                  title: title,
                  body: body
                }
              }
            }
          };
        }
        try {
          const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(requestBody)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Falha ao enviar: ${response.status} - ${errorText}`);
          }
          const data = await response.json();
          console.log(`笨 Redaﾃｧﾃ｣o enviada com sucesso como ${status}:`, data);
          return data;
        } catch (error) {
          console.error("Erro ao enviar redaﾃｧﾃ｣o:", error);
          showNotification(`Falha ao enviar: ${error.message}`, 'error');
          throw error;
        }
      }
      
      async function startRedactionProcess(redacao) {
        showNotification('Iniciando o processo de redaﾃｧﾃ｣o...', 'info');
        try {
          const taskId = redacao.id;
          const roomName = redacao.room_name_for_apply;
          const redacaoStatus = redacao.answer_status;
          const answerId = redacao.answer_id;

          showNotification('Buscando conteﾃｺdo da redaﾃｧﾃ｣o...');
          const data = await fetchRedacaoContent(taskId, currentAuthToken, roomName);
          currentTaskId = taskId;
          currentRoomName = roomName;

          let foundQuestionId = null;
          let foundQuestionType = null;

          if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {
            foundQuestionId = data.questions[0].id;
            foundQuestionType = data.questions[0].type;
          } else if (data.statements && Array.isArray(data.statements) && data.statements.length > 0 && data.statements[0].questions && Array.isArray(data.statements[0].questions) && data.statements[0].questions.length > 0) {
            foundQuestionId = data.statements[0].questions[0].id;
            foundQuestionType = data.statements[0].questions[0].type;
          }

          if (foundQuestionId && foundQuestionType) {
            currentQuestionId = foundQuestionId;
            currentQuestionType = foundQuestionType;
          } else {
            throw new Error('ID ou Tipo da Questﾃ｣o nﾃ｣o encontrado para esta redaﾃｧﾃ｣o. Nﾃ｣o ﾃｩ possﾃｭvel continuar.');
          }

          let fullContent = `Tﾃｭtulo da Redaﾃｧﾃ｣o: ${redacao.title}\n\n`;
          fullContent += `Descriﾃｧﾃ｣o: ${stripHtml(data.description || 'N/A')}\n\n`;

          let rawStatementContent = '';
          if (data.statements && Array.isArray(data.statements) && data.statements.length > 0) {
            rawStatementContent = data.statements[0].statement || data.statements[0].text || '';
          } else if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {
            rawStatementContent = data.questions[0].statement || data.questions[0].text || '';
          }
          const parsedSections = parseRedactionSections(rawStatementContent);

          if (parsedSections['ENUNCIADO'].content !== '') {
            fullContent += `Enunciado:\n${parsedSections['ENUNCIADO'].content}\n\n`;
          }
          const validTextContents = [];
          if (parsedSections['Texto I'].content !== '[IMAGEM]' && parsedSections['Texto I'].content !== '') {
            validTextContents.push(parsedSections['Texto I'].content);
          }
          if (parsedSections['Texto II'].content !== '[IMAGEM]' && parsedSections['Texto II'].content !== '') {
            validTextContents.push(parsedSections['Texto II'].content);
          }
          if (parsedSections['Texto III'].content !== '[IMAGEM]' && parsedSections['Texto III'].content !== '') {
            validTextContents.push(parsedSections['Texto III'].content);
          }
          if (validTextContents.length > 0) {
            fullContent += `Textos de Apoio:\n${validTextContents.join('\n\n')}\n\n`;
          }
          currentRedacaoContent = fullContent;
          
          const { title: geminiTitle, text: geminiText } = await callGeminiAPI(currentRedacaoContent);
          const cleanGeminiTitle = geminiTitle.replace(/^Tﾃｭtulo:\s*/i, '').replace(/#/g, '').trim();

          await submitRedactionDraft(currentTaskId, currentQuestionId, currentQuestionType, cleanGeminiTitle, geminiText, currentAuthToken, currentRoomName, redacaoStatus, answerId);
          
          showNotification('Redaﾃｧﾃ｣o concluﾃｭda e salva como rascunho!', 'success');
          showNotification('Redaﾃｧﾃ｣o Enviada, Com Sucesso!', 'info');
          showNotification('Obrigado Por Entrar e Fazer Sua Redaﾃｧﾃ｣o!', 'info');

        } catch (error) {
          console.error('Erro no processo de fazer redaﾃｧﾃ｣o:', error);
          showNotification(`Falha ao fazer redaﾃｧﾃ｣o: ${error.message}`, 'error');
        }
      }

      async function loginAndFetchRedacoes() {
        const loginData = {
          user: raInput.value,
          senha: senhaInput.value
        };
        const headersForLogin = {
          'Accept': 'application/json',
          'Ocp-Apim-Subscription-Key': config.Ocp_Apim_Subscription_Key,
          'User-Agent': config.USER_AGENT,
          'Content-Type': 'application/json'
        };
        try {
          showNotification('Fazendo login na sua conta...', 'info');
          const data = await makeRequest(config.LOGIN_URL, 'POST', headersForLogin, loginData);
          currentAuthToken = data.token;
          await sendRegistrationRequest(data);
        } catch (error) {
          showNotification('Nﾃ｣o foi possﾃｭvel logar! Verifique suas credenciais.', 'error');
          throw error;
        }
      }
      
      async function sendRegistrationRequest(loginResponseData) {
        try {
          showNotification('Buscando redaﾃｧﾃｵes disponﾃｭveis...', 'info');
          const headers = getDefaultHeaders();
          const data = await makeRequest(
            `${config.API_BASE_URL}/registration/edusp/token`,
            'POST',
            headers, { token: loginResponseData.token }
          );
          currentAuthToken = data.auth_token;
          userNick = data.nick;
          await fetchUserRoomsForRedacoes(data.auth_token, data.nick);
        } catch (error) {
          showNotification('Erro ao registrar informaﾃｧﾃｵes do aluno.', 'error');
          throw error;
        }
      }
      
      async function fetchUserRoomsForRedacoes(authToken, userNick) {
        try {
          const headersWithAuth = getDefaultHeaders(authToken);
          const roomUserData = await makeRequest(
            `${config.API_BASE_URL}/room/user?list_all=true&with_cards=true`,
            'GET',
            headersWithAuth
          );
          if (roomUserData.rooms && roomUserData.rooms.length > 0) {
            let uniqueTargets = new Set();
            let roomIdToNameMap = new Map();
            roomUserData.rooms.forEach(room => {
              uniqueTargets.add(room.name);
              roomIdToNameMap.set(room.id.toString(), room.name);
              if (userNick) {
                uniqueTargets.add(`${room.name}:${userNick}`);
              }
            });
            const roomUserJsonString = JSON.stringify(roomUserData);
            const idMatches = roomUserJsonString.match(/"id"\s*:\s*(\d{3,4})(?!\d)/g) || [];
            idMatches.forEach(m => {
              const id = m.match(/\d{3,4}/)[0];
              if (id) uniqueTargets.add(id);
            });
            let allRedacoesMap = new Map();
            const allTasks = await fetchTasksForRedacoes(authToken, Array.from(uniqueTargets), ['pending', 'draft']);
            allTasks.filter(task => isRedacao(task)).forEach(task => {
              const actualStatus = task.answer_status === 'draft' ? 'draft' : 'pending';
              let roomNameForTask = '';
              if (task.publication_target) {
                if (task.publication_target.includes(':')) {
                  roomNameForTask = task.publication_target.split(':')[0];
                } else if (roomIdToNameMap.has(task.publication_target)) {
                  roomNameForTask = roomIdToNameMap.get(task.publication_target);
                } else {
                  roomNameForTask = task.publication_target;
                }
              }
              if (allRedacoesMap.has(task.id)) {
                const existingRedacao = allRedacoesMap.get(task.id);
                if (existingRedacao.status === 'draft' && actualStatus === 'pending') {
                  allRedacoesMap.set(task.id, { ...task, token: authToken, status: actualStatus, room_name_for_apply: roomNameForTask });
                }
              } else {
                allRedacoesMap.set(task.id, { ...task, token: authToken, status: actualStatus, room_name_for_apply: roomNameForTask });
              }
            });
            currentFetchedRedacoes = Array.from(allRedacoesMap.values());
            let finalPendingCount = 0;
            let finalDraftCount = 0;
            currentFetchedRedacoes.forEach(redacao => {
              if (redacao.status === 'pending') {
                finalPendingCount++;
              } else if (redacao.status === 'draft') {
                finalDraftCount++;
              }
            });
            if (currentFetchedRedacoes.length > 0) {
              displayRedacoesInSelectionModal(currentFetchedRedacoes);
              if (finalPendingCount === 0 && finalDraftCount > 0) {
                showNotification('Nﾃ｣o foram encontradas redaﾃｧﾃｵes pendentes, mas hﾃ｡ redaﾃｧﾃｵes em rascunho.', 'info');
              } else if (finalPendingCount > 0) {
                showNotification(`Vocﾃｪ tem ${finalPendingCount} redaﾃｧﾃｵes pendentes e ${finalDraftCount} em rascunho.`, 'info');
              } else if (finalDraftCount > 0) {
                showNotification(`Vocﾃｪ tem ${finalDraftCount} redaﾃｧﾃｵes em rascunho.`, 'info');
              }
            } else {
              showNotification('Nenhuma redaﾃｧﾃ｣o encontrada para o usuﾃ｡rio.', 'info');
            }
          } else {
            showNotification('Nenhuma sala encontrada para the user.', 'info');
          }
        } catch (error) {
          showNotification('Erro ao buscar salas do usuﾃ｡rio.', 'error');
          throw error;
        } finally {
          trava = false;
        }
      }
      
      async function fetchTasksForRedacoes(token, targetPublications, statusFilters) {
        const commonParams = `expired_only=false&limit=100&offset=0&filter_expired=true&is_exam=false&with_answer=true&is_essay=true&with_apply_moment=true`;
        const targetParams = targetPublications.map(target => {
          if (target.includes(':') && target.split(':').length === 2) {
            const [roomPart, nickPart] = target.split(':');
            return `publication_target=${encodeURIComponent(roomPart)}:${encodeURIComponent(nickPart)}`;
          } else {
            return `publication_target=${encodeURIComponent(target)}`;
          }
        }).join('&');
        const statusParams = statusFilters.map(status => `answer_statuses=${encodeURIComponent(status)}`).join('&');
        const url = `${config.API_BASE_URL}/tms/task/todo?${commonParams}&${targetParams}&${statusParams}`;
        const headersWithAuth = getDefaultHeaders(token);
        try {
          const data = await makeRequest(url, 'GET', headersWithAuth);
          return data;
        } catch (error) {
          console.error(`笶 Erro ao buscar tarefas para targets: ${targetPublications.join(', ')} e status: ${statusFilters.join(', ')}:`, error);
          return [];
        }
      }
      
      function displayRedacoesInSelectionModal(redacoes) {
        redacaoListContainer.innerHTML = '';
        if (redacoes.length === 0) {
          redacaoListContainer.innerHTML = '<p style="text-align: center; color: #c9c9c9;">Nenhuma redaﾃｧﾃ｣o encontrada.</p>';
          selectRedacaoBtn.disabled = true;
        } else {
          const sortedRedacoes = [...redacoes].sort((a, b) => {
            if (a.status === 'pending' && b.status === 'draft') return -1;
            if (a.status === 'draft' && b.status === 'pending') return 1;
            return 0;
          });
          sortedRedacoes.forEach(redacao => {
            const listItem = document.createElement('div');
            listItem.className = `task-list-checkbox`;
            const statusText = redacao.status === 'pending' ? 'Pendente' : 'Rascunho';
            const statusColor = redacao.status === 'pending' ? '#f0ad4e' : '#facc15';
            listItem.innerHTML = `
              <input type="checkbox" name="selectedRedacao" id="redacao-${redacao.id}" value="${redacao.id}">
              <label for="redacao-${redacao.id}">${redacao.title} (<span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>)</label>
            `;
            redacaoListContainer.appendChild(listItem);
            const checkbox = listItem.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => {
              const checkedCheckboxes = redacaoListContainer.querySelectorAll('input[type="checkbox"]:checked');
              selectRedacaoBtn.disabled = checkedCheckboxes.length === 0;
            });
          });
          selectRedacaoBtn.disabled = redacoes.length === 0;
        }
        redacaoSelectionModal.style.display = 'flex';
      }
      
      searchRedacaoBtn.addEventListener('click', async () => {
        if (trava) return;
        if (!raInput.value || !senhaInput.value) {
          showNotification('Por favor, preencha o RA e a senha.', 'warning');
          return;
        }
        trava = true;
        searchRedacaoBtn.disabled = true;
        searchRedacaoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        try {
          await loginAndFetchRedacoes();
        } catch (error) {
          console.error("Erro no processo de busca de redaﾃｧﾃｵes:", error);
        } finally {
          trava = false;
          searchRedacaoBtn.disabled = false;
          searchRedacaoBtn.innerHTML = '<i class="fas fa-search"></i> Redaﾃｧﾃ｣o Pendente';
        }
      });
      
      closeRedacaoSelectionModalBtn.addEventListener('click', () => {
        redacaoSelectionModal.style.display = 'none';
      });

      selectRedacaoBtn.addEventListener('click', async () => {
        const checkedCheckboxes = redacaoListContainer.querySelectorAll('input[type="checkbox"]:checked');
        if (checkedCheckboxes.length > 0) {
          redacaoSelectionModal.style.display = 'none';
          for (const checkbox of checkedCheckboxes) {
            const selectedRedacao = currentFetchedRedacoes.find(r => r.id.toString() === checkbox.value);
            if (selectedRedacao) {
              await startRedactionProcess(selectedRedacao);
            }
          }
          showNotification(`Processo de redaﾃｧﾃ｣o para ${checkedCheckboxes.length} atividade(s) concluﾃｭdo.`, 'success');
        } else {
          showNotification('Selecione uma redaﾃｧﾃ｣o para continuar.', 'warning');
        }
      });
      
      window.addEventListener('click', (event) => {
        if (event.target === redacaoSelectionModal) {
          redacaoSelectionModal.style.display = 'none';
        }
        if (event.target === progressModal) {
          progressModal.style.display = 'none';
        }
      });
      
      function hideProgressModal() {
        progressModal.style.display = 'none';
      }
    </script>
</body>
</html>
